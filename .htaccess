# Serve index.php by default
DirectoryIndex index.php

# Avoid content-negotiation 404s in subfolders
Options -MultiViews

###############################################
# Force HTTPS on non-local environments
###############################################
<IfModule mod_rewrite.c>
    RewriteEngine On

    # Skip HTTPS redirect on localhost environments
    RewriteCond %{HTTP_HOST} !^localhost$ [NC]
    RewriteCond %{HTTP_HOST} !^127\.0\.0\.1$ [NC]

    # Already HTTPS? do nothing
    RewriteCond %{HTTPS} !=on
    # Behind proxy/load balancer using X-Forwarded-Proto
    RewriteCond %{HTTP:X-Forwarded-Proto} !https [NC]
    # Redirect to HTTPS
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</IfModule>

# Enable URL rewriting for CodeIgniter 3 (remove index.php)
<IfModule mod_rewrite.c>
    RewriteEngine On

    # Exclude Let's Encrypt challenge path
    RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge/

    # If the request is for an existing file or directory, serve it directly
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d

    # Otherwise route to index.php
    RewriteRule ^(.*)$ index.php/$1 [L]
</IfModule>

# Security headers (optional but recommended)
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
</IfModule>
